{% extends "base.html" %}

{% block title %}Protocol Analysis - Network Traffic Analysis{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        margin-top: 30px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
    }
    .info-box {
        background: #e8f4f8;
        border-left: 4px solid #29b6f6;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2>üîó Protocol Analysis by Attack Type</h2>
        <p class="text-muted">Breakdown of network protocols used in different attack types</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Back to Home</a>
    </div>
</div>

<div class="info-box">
    <strong>‚ÑπÔ∏è Info:</strong> This analysis shows the distribution of protocols across different attack types. Each bar represents the count of a specific protocol within an attack type.
</div>

<!-- Chart Display -->
{% if protocol_data %}
    <div class="chart-container">
        <canvas id="protocolChart"></canvas>
    </div>

    <!-- Data Table -->
    <div class="mt-4">
        <h5>üìä Data Summary</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Attack Type</th>
                        <th>Protocol</th>
                        <th class="text-end">Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in protocol_data %}
                        <tr>
                            <td><strong>{{ row['Attack Type'] }}</strong></td>
                            <td>{{ row['protocol'] }}</td>
                            <td class="text-end">{{ row['protocol_count'] }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="text-muted small">
            <p>Total records: <strong>{{ protocol_data|length }}</strong></p>
        </div>
    </div>
{% else %}
    <div class="alert alert-warning">
        No protocol data available. Please check your database.
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    {% if protocol_data %}
    // Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨: Attack TypeÎ≥Ñ Protocol Í∑∏Î£πÌôî
    const dataByAttackType = {};
    const allProtocols = new Set();
    
    [{% for row in protocol_data %}
        {
            attackType: '{{ row["Attack Type"] }}',
            protocol: '{{ row["protocol"] }}',
            count: {{ row['protocol_count'] }}
        }{{ "," if not loop.last }}
    {% endfor %}].forEach(item => {
        if (!dataByAttackType[item.attackType]) {
            dataByAttackType[item.attackType] = {};
        }
        dataByAttackType[item.attackType][item.protocol] = item.count;
        allProtocols.add(item.protocol);
    });
    
    const attackTypes = Object.keys(dataByAttackType).sort();
    const protocols = Array.from(allProtocols).sort();
    
    // Ïª¨Îü¨ ÌåîÎ†àÌä∏
    const colors = [
        '#5975a4', '#cc5de8', '#845b97', '#d45087',
        '#ff6e40', '#ffa726', '#ffb74d', '#ffb366',
        '#66bb6a', '#26a69a', '#29b6f6', '#42a5f5',
        '#ec407a', '#ab47bc', '#7e57c2', '#5c6bc0'
    ];
    
    // Í∞Å ProtocolÎ≥Ñ Dataset ÏÉùÏÑ±
    const datasets = protocols.map((protocol, index) => {
        return {
            label: protocol,
            data: attackTypes.map(attackType => {
                return dataByAttackType[attackType][protocol] || 0;
            }),
            backgroundColor: colors[index % colors.length],
            borderColor: '#333',
            borderWidth: 1,
            borderRadius: 4
        };
    });
    
    const ctx = document.getElementById('protocolChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: attackTypes,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        boxWidth: 15,
                        font: { size: 12 }
                    }
                },
                title: {
                    display: true,
                    text: 'Protocol Distribution by Attack Type'
                }
            },
            scales: {
                x: {
                    stacked: false,
                    title: {
                        display: true,
                        text: 'Attack Type'
                    }
                },
                y: {
                    stacked: false,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Protocol Count'
                    }
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}
